BAZAAR-303 — “Publish & Share” Pipeline  🚀

	
Sprint	27 (primary BE story)
Owner	Platform pod (♟ lead: you)
Depends on	302 (scenes in DB)
Parallels	304 (workspace UI)


⸻

0 · TL;DR

Ship a one-click Publish button that:
	1.	Bundles a scene or an entire storyboard with esbuild.
	2.	Uploads the artifact to Cloudflare R2 (public-read).
	3.	Returns a permanent CDN URL and surfaces it in the UI (copy + open).
	4.	Runs off the request thread — user sees live status: “Queued → Bundling → Uploading → Published ✓”.

⸻

1 · Why
	•	302 gives us near-instant preview, but everything is still local.
	•	Users need a friction-free way to post an animation in Slack, Twitter, Loom, etc.
	•	URLs must be immutable so later edits don’t break already-shared links.

⸻

2 · Goals & Scope (MVP)

Area	Goal
Bundling	Tree-shake React & Remotion externals; produce one ESM file + optional data-URIs (≤10 kB). Bundler must work for (a) a single scene or (b) a stitched storyboard (future flag, default = scene).
Storage	Upload to R2 with deterministic key: projects/{projectId}/scenes/{sceneId}/{sha256}.js.
URL	Return public HTTPS URL (via Workers custom domain) → store in scenes.published_url.
Status	Expose progress: queued → bundling → uploading → published; UI polls or subscribes.
Async	All heavy lifting in a job queue (BullMQ 🔌 Redis preferred, Dexie fallback).
Permissions	Only owner / collaborators can publish; public URL is read-only.
Roll-forward	Re-publishing same scene emits a new hash; old links remain valid.
CI	Type-check & tests ✅.
Out of scope	Full video (FFmpeg) render; private/expiring links; transitions stitching (304).


⸻

3 · Detailed Requirements

3.1 Backend

#	Item	Notes
B1	Bundler util – packages/bundler/index.tsts
export async function bundleScene(sceneId: string, opts?: { fullStoryboard?: boolean }): Promise<{ bytes: Buffer; hash: string; size: number }>
 * esbuild (browser,esm,es2022), external react & remotion.  * Inline CSS/SVG/PNG ≤10 kB → data URI.  * Optional fullStoryboard stitches scenes together via autogenerated index.tsx.	
B2	R2 client wrapper – packages/r2/index.ts. Uses @aws-sdk/client-s3 with AWS_S3_FORCE_PATH_STYLE=1.	
B3	Job queue – queues/publish.ts. States: queued ▶ bundling ▶ uploading ▶ done ▶ failed. Max runtime 60 s.	
B4	tRPC• publishScene(sceneId, scope) – enqueue, return jobId. • publishStatus(jobId) – query or websocket subscription.	
B5	DB migration (drizzle):sql
ALTER TABLE scenes
ADD COLUMN published_url text,
ADD COLUMN published_hash text,
ADD COLUMN published_at timestamptz;
CREATE INDEX IF NOT EXISTS scene_publish_idx ON scenes(project_id, published_hash);
	
B6	Dedup: if hash already exists in R2, skip upload, immediately return URL.	

3.2 Frontend (GenerateWorkspace / GenerateVideoClient)
	1.	Publish button next to Compile & Test (disabled if scene has compile errors).
	2.	Click → publishScene.
	3.	Sonner modal (or Sheet) shows live steps (poll every 1 s or subscribe).
	4.	Success → green check, show URL with Copy & Open buttons; scene list shows link-icon.
	5.	On error → red toast, “Retry” button retains last jobId.

3.3 Security
	•	Authorise scene ownership in both publishScene & job worker.
	•	Bundle is generated server-side from DB code only – never trust code shipped from client.

3.4 Instrumentation & Limits

Metric	Logged to
bundle size (B)	bunyan + scenes.published_size (optional column)
esbuild ms	same
upload ms	same
warn if size > 500 kB	toast on UI + bunyan warn


⸻

4 · Task Breakdown

#	Task	Owner	Est.
T1	Bundler package + unit tests w/ fixture scene	BE	1 d
T2	R2 wrapper + env plumbing (R2_ACCESS_KEY …)	BE	0.5 d
T3	Job queue infra (BullMQ; fallback Dexie)	BE	1 d
T4	DB migration + Drizzle models	BE	0.25 d
T5	tRPC publishScene / publishStatus (query & WS)	BE	0.5 d
T6	Front-end Publish UI (button, modal, polling)	FE	1 d
T7	Scene-list icon / URL surfacing	FE	0.25 d
T8	Unit tests: bundler (+ mock S3) & queue state	BE	0.5 d
T9	Cypress smoke: “generate → publish → open URL”	QA	0.5 d
T10	Docs: docs/publish-flow.md + README link	DX	0.25 d
Buffer	Fixes & polish	—	0.75 d

Total ≈ 6.5 engineer-days — still one sprint.

⸻

5 · Definition of Done
	1.	Publish works E2E in staging.
	2.	Re-publish creates new immutable URL (hash diff).
	3.	Bundle loads in standalone HTML page (imports window.React, window.Remotion).
	4.	Job status UI latency < 100 ms (polling or WS).
	5.	npm run typecheck clean.
	6.	Unit tests ≥ 90 % lines for bundler + R2 util.
	7.	Cypress happy-path passes.
	8.	Docs updated & linked.
	9.	CI green.

⸻

6 · Risks & Mitigations

Risk	Mitigation
esbuild fails on exotic code	try/catch; pipe diagnostics back via job error + toast.
R2 creds / region wrong	start-up assert + health-check endpoint.
Bundle > 500 kB	warn & gzip; 305 will add code-splitting.
Long jobs block queue	per-job 60 s timeout; future ticket for async video render.
Hash collision / overwrite	SHA-256 of bytes; impossible collision for practical purposes.


⸻

7 · Nice-to-Have (305+)
	•	HTML “embed snippet” generator with <script type="module" src="…"></script>.
	•	Publish entire storyboard with auto-transitions.
	•	Private / expiring links & access analytics.
	•	Cancel / retry buttons on job modal.

⸻

8 · Alignment with Roadmap
	•	302 – scenes persisted ✅
	•	303 – publish those scenes ✅ this ticket
	•	304 – new workspace UI with drag-reorder ✅ (parallel)
	•	305 – video render, transitions, analytics (future)

⸻