# Component Recovery System Database Schema Update

## Overview

As part of Sprint 20's Component Recovery System implementation, we've updated the database schema to support tracking fixable components and storing information about component fixes. This document summarizes the schema changes and how they were applied.

## Schema Changes

We've added the following columns to support the Component Recovery System:

1. **originalTsxCode**: Stores the original TSX code before any fixes are applied
2. **lastFixAttempt**: Timestamp of the most recent fix attempt
3. **fixIssues**: List of issues identified and fixed by the preprocessor

These columns were added to the following tables:

- `bazaar-vid_custom_component_job`
- `bazaar-vid_animation_design_brief`
- `bazaar-vid_message`

Additionally, we added an index on the status column to optimize queries for fixable components:

- `custom_component_jobs_status_idx` on `bazaar-vid_custom_component_job(status)`

## Implementation Approach

Due to challenges with the standard migration process (existing tables causing errors), we implemented a custom approach:

1. Created scripts to add the necessary columns and indexes using the `ALTER TABLE` SQL command with `IF NOT EXISTS` for safety:
   - `src/scripts/add-component-recovery-columns.ts`
   - `src/scripts/add-adb-recovery-columns.ts`
   - `src/scripts/add-message-recovery-columns.ts`

2. Added a verification script to confirm all changes were applied correctly:
   - `src/scripts/verify-recovery-schema.ts`

These scripts connect directly to the Neon PostgreSQL database using the Neon HTTP client and execute the necessary SQL commands.

## Status Transitions

With these schema changes, components can now have the following statuses:

| Status      | Description                                      |
|-------------|--------------------------------------------------|
| `pending`   | Initial state, waiting for processing            |
| `generating`| Currently being generated by the LLM             |
| `failed`    | Generation failed with non-fixable errors        |
| `fixable`   | Failed but can be fixed with the TSX preprocessor|
| `fixing`    | Currently being fixed by the preprocessor        |
| `building`  | Currently being built (esbuild compilation)      |
| `complete`  | Successfully generated, built and deployed       |

The schema update includes logic to automatically update components from `failed` to `fixable` status if they have TSX code that might be fixable.

## Verification Results

The schema changes were successfully applied and verified. The verification script confirmed:

1. All required columns exist in all three tables
2. The status index was created correctly
3. The migration is ready for use with the Component Recovery System

## Next Steps

1. Deploy the frontend UI components that interact with the fixable components
2. Test the full Component Recovery System workflow
3. Monitor the component fix success rate and gather metrics 