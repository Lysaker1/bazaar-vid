//memory-bank/sprints/sprint31/ASK-SPECIFY.md
# Ask Specify Tool Analysis (`askSpecify.ts`)

This document provides a detailed analysis of the `AskSpecifyTool` found in `src/lib/services/mcp-tools/askSpecify.ts`. This tool is invoked when the system determines that a user's request is ambiguous and requires clarification before proceeding with an action.

## 1. Overview

- **File Location**: `src/lib/services/mcp-tools/askSpecify.ts`
- **Purpose**: To generate a specific clarification question to ask the user when their intent is unclear. It aims to guide the user towards providing the necessary information for the system to act.
- **Core Mechanism**: Relies heavily on the `conversationalResponseService` to generate both the primary clarification question and a user-facing chat response. It also includes fallback logic for generating questions if the primary service fails.

## 2. Input Schema (`askSpecifyInputSchema`)

The tool expects an input object validated by a Zod schema:

-   `userPrompt` (string, required): The original ambiguous request from the user.
-   `ambiguityType` (enum, required): Specifies the nature of the ambiguity. Possible values:
    *   `'scene-selection'`: User mentioned an action but it's unclear which scene it applies to.
    *   `'action-unclear'`: The system doesn't understand what action the user wants to perform.
    *   `'parameter-missing'`: A required parameter for an action is missing (e.g., color for a color change request).
    *   `'duration_intent'`: User mentioned duration, but it's unclear if they mean scene length, animation speed, or both.
-   `availableScenes` (array of objects, optional): A list of scenes currently in the project, used when `ambiguityType` is `'scene-selection'` or for general context. Each object contains:
    *   `id` (string)
    *   `name` (string)
    *   `number` (number, optional)
-   `projectId` (string, required): The ID of the current project, for context.
-   `context` (record of any, optional): Any additional contextual information that might help in formulating the clarification question.

## 3. Output Structure (`AskSpecifyOutput`)

The tool produces an output object containing:

-   `clarificationQuestion` (string): The specific question generated to ask the user for clarification.
-   `ambiguityType` (string): The type of ambiguity that triggered this tool (passed through from input).
-   `availableOptions` (array of strings, optional): A list of suggested options or choices for the user to pick from, relevant to the `ambiguityType` (e.g., list of scene names for `'scene-selection'`, or options for `'duration_intent'`).
-   `reasoning` (string): An internal note explaining why clarification is needed (e.g., "Need clarification: scene-selection").
-   `chatResponse` (string, optional): The user-facing message, which in most cases is the same as `clarificationQuestion`. This is generated by `conversationalResponseService`.

## 4. Operational Flow

1.  **Input Validation**: The input object is validated against `askSpecifyInputSchema`.
2.  **Clarification Question Generation**:
    *   Calls `conversationalResponseService.generateClarificationQuestion` with `userPrompt`, `availableScenes`, `ambiguityType`, and `context` to get the primary `clarificationQuestion`.
3.  **Conversational Response Generation**:
    *   Calls `conversationalResponseService.generateContextualResponse` with `operation: 'askSpecify'`, the `userPrompt`, and results including `ambiguityType` and the generated `clarificationQuestion`.
    *   The output of this is typically used as the `chatResponse`.
4.  **Determine Available Options**:
    *   Based on the `ambiguityType`, a list of `availableOptions` might be generated:
        *   For `'scene-selection'`: Maps `availableScenes` to a list of strings like "Scene {number or id}: {name}".
        *   For `'duration_intent'`: Provides predefined options like changing total duration, animation speed, or both.
5.  **Output Assembly**: The `clarificationQuestion`, `ambiguityType`, `availableOptions`, `reasoning`, and `chatResponse` are compiled into the `AskSpecifyOutput` object.
6.  **Error Handling (Fallback)**: If `conversationalResponseService.generateClarificationQuestion` fails:
    *   An error is logged.
    *   A fallback clarification question is generated locally by the `getFallbackQuestion` private method, based on `ambiguityType` and `availableScenes`.
    *   This fallback question is used for both `clarificationQuestion` and `chatResponse`.

## 5. Integration with System

-   The `AskSpecifyTool` is an MCP tool invoked by the `BrainOrchestrator` when the orchestrator's LLM indicates that the user's request is ambiguous (often by selecting this tool or returning a specific flag).
-   The `chatResponse` (or `clarificationQuestion`) from this tool is sent back to the user through the chat interface.
-   The user's subsequent reply is then processed by the orchestrator, hopefully with the ambiguity resolved, allowing the system to proceed with the intended action (e.g., calling `EditSceneTool` or `AddSceneTool`).

## 6. Key Dependencies

-   **Zod**: For input schema definition and validation.
-   **`BaseMCPTool`**: The base class for MCP tools.
-   **`conversationalResponseService`**: The primary service for generating clarification questions and user-facing responses.

## 7. Considerations

-   The effectiveness of this tool hinges on the `conversationalResponseService`'s ability to generate clear and concise clarification questions tailored to the ambiguity.
-   The `ambiguityType` enum is crucial for directing the clarification logic.
-   The fallback mechanism (`getFallbackQuestion`) ensures that the system can still ask for clarification even if the primary response generation service fails, enhancing robustness.
-   Providing `availableOptions` can significantly improve user experience by making it easier for users to respond to clarification requests.
