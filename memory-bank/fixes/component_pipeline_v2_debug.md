# Component Pipeline Debug Log (Sprint 22 - 2025-05-15)\n\nThis document tracks the investigation and fixes for critical issues in the custom component generation and build pipeline, primarily focusing on \"TSX code is missing\" errors and subsequent build failures.\n\n## Initial Problem Statement (Mid-May 2025)\n\nNewly generated custom components were frequently failing. The primary symptoms were:\n1.  **\"TSX code is missing for this job\"**: Displayed in the UI for components, and logged as an error by the build worker (`src/server/workers/buildCustomComponent.ts`). This indicated that the `tsxCode` field in the `customComponentJobs` database table was `NULL` when the build worker attempted to process the job.\n2.  **Components Stuck in UI**: Components would appear in the UI with statuses like \"generating_code\" but never progress, or would show the \"TSX code is missing\" error.\n3.  **Build Failures (esbuild)**: For components that did have `tsxCode` (e.g., after manual fixes or if they survived the initial race condition), they would sometimes fail during the `esbuild` process with syntax errors like `Expected \")\" but found \";\"`.\n\n## Root Cause Analysis & Hypotheses\n\n### 1. Race Condition (Primary cause for \"TSX code is missing\")\n*   **Job Creation**: New component jobs were initially set to a `pending` status by the `componentGenerator.service.ts` (or the tRPC endpoint it calls, `customComponentRouter.create`).\n*   **Asynchronous Code Generation**: `componentGenerator.service.ts` called `processComponentJob` (from `generateComponentCode.ts`) asynchronously to generate the TSX code via LLM, validate it, and then update the job status and `tsxCode` in the database.\n*   **Premature Build Attempt**: The `buildWorker.ts` (specifically `checkForPendingJobs`) was polling for jobs with `status: \"pending\"`. It often picked up new jobs *before* `processComponentJob` had completed the code generation and saved the `tsxCode`.\n*   **Result**: The build worker would find `tsxCode: null` for the job and correctly report the \"TSX code is missing\" error, often setting the job status to `error`.\n\n### 2. Inadequate Error Handling in Code Generation Pipeline\n*   If errors occurred during the LLM call, syntax validation (`validateComponentSyntax`), or preprocessing steps (`tsxPreprocessor.ts`, `repairComponentSyntax.ts`) within `generateComponentCode.ts -> processComponentJob`:\n    *   It was hypothesized that the system might not be reliably saving the faulty LLM-generated `tsxCode` or a generated fallback `tsxCode` to the database.\n    *   If `handleComponentGenerationError` failed to update the DB with *some* code, the `tsxCode` field would remain `null`.\n\n### 3. Preprocessing and Build-Time Errors\n*   **`tsxPreprocessor.ts` Regex Error**: A regex in the `fixJsxStructure` function (`new RegExp(\`</\${mainTag}>\\s*\\)\\s*;\\s*$\`)`) was causing an `Invalid regular expression: Unmatched \')\'` error, potentially halting preprocessing and preventing `tsxCode` from being correctly processed or saved.\n*   **`fixSyntaxIssues` in `buildCustomComponent.ts`**: An overly aggressive rule was adding semicolons after JSX closing tags (`fixed = fixed.replace(/(<\\/[a-zA-Z][a-zA-Z0-9]*>)(\\s*(?![;\\s\\na-zA-Z<]))/g, \'$1;$2\');`). This was leading to `esbuild` errors like `Expected \")\" but found \";\"` because it could insert a semicolon in an invalid syntactic position (e.g., `</AbsoluteFill>; );`).\n*   **`Unexpected strict mode reserved word`**: This error, observed during component validation for the Tetris components, suggested issues either with the LLM output directly containing \"use strict\" or with keywords being used incorrectly after preprocessing.\n\n## Corrective Actions Implemented\n\n### 1. Status Flow Overhaul (Addressing Race Condition)\n*   **Initial Status Change**: Modified `src/server/api/routers/customComponent.ts` (`create` mutation) to set the initial status of new jobs to `\"queued_for_generation\"` instead of `\"pending\"`.\n    *   *File*: `src/server/api/routers/customComponent.ts`\n    *   *Change*: `status: \"pending\"` -> `status: \"queued_for_generation\"`\n*   **Intermediate Status in Code Generation**: Updated `processComponentJob` in `src/server/workers/generateComponentCode.ts` to set the job status to `\"generating_code\"` immediately upon starting processing for a job.\n    *   *File*: `src/server/workers/generateComponentCode.ts`\n    *   *Change*: Added DB update to set `status: \"generating_code\"` at the beginning of `processComponentJob`.\n*   **Build Worker Query Update**: Modified `checkForPendingJobs` in `src/server/cron/buildWorker.ts` to query for jobs with `status: \"building\"` (or `\"manual_build_retry\"`) instead of `\"pending\"`.\n    *   *File*: `src/server/cron/buildWorker.ts`\n    *   *Change*: `where(eq(customComponentJobs.status, \"pending\"))` -> `where(or(eq(customComponentJobs.status, \"building\"), eq(customComponentJobs.status, \"manual_build_retry\")))`.\n    *   Corrected subsequent logic to call `processPendingJobs()` (from `buildCustomComponent.ts`) without arguments, as it handles its own batch fetching based on the `building` status.\n\n### 2. TSX Preprocessing Fixes\n*   **`tsxPreprocessor.ts` Regex Fix**: Corrected the problematic regex in `fixJsxStructure` to properly escape parentheses for `RegExp` constructor.\n    *   *File*: `src/server/utils/tsxPreprocessor.ts`\n    *   *Change*: `new RegExp(\`</\${mainTag}>\\s*\\)\\s*;\\s*$\`)` -> `new RegExp(\`</\${mainTag}>\\\\s*\\\\)\\\\s*;\\\\s*$\`)` and `replace(/(\\s*\\)\\s*;\\s*)$/, ...)` -> `replace(new RegExp('(\\\\s*\\\\)\\\\s*;\\\\s*)$'), ...)`.\n*   **`fixSyntaxIssues` Semicolon Adjustment**: Commented out the aggressive semicolon insertion rule in `fixSyntaxIssues` within `src/server/workers/buildCustomComponent.ts` to prevent esbuild errors.\n    *   *File*: `src/server/workers/buildCustomComponent.ts`\n    *   *Change*: Commented out `fixed = fixed.replace(/(<\\/[a-zA-Z][a-zA-Z0-9]*>)(\\s*(?![;\\s\\na-zA-Z<]))/g, \'$1;$2\');`.\n\n### 3. Logging Enhancements\n*   Improved logging in `handleComponentGenerationError` (`src/server/workers/generateComponentCode.ts`) to:\n    *   Clearly log whether input `tsxCode` was null or had content (and its length).\n    *   Log the length of `generatedFallbackCode` if created.\n    *   Add a consolidated `[DB_UPDATE_PREP]` log entry showing `tsxToSave` length, `statusToSave`, and `errorMessageToSave` before the database update.\n\n## Current Status & Next Steps (as of end of this session)\n\n*   The above fixes have been applied.\n*   **Crucial Unverified Step**: The **code generation poller** (the system that takes jobs from `queued_for_generation` and calls `processComponentJob`) has not been explicitly identified and modified within this session. The user needs to ensure this poller correctly queries for the `queued_for_generation` status.\n*   The UI still shows components stuck at \"generating_code\". This is expected if the code generation poller isn't looking for the new initial status, or if new errors are occurring in `processComponentJob` (e.g., the `Unexpected strict mode reserved word` error) that prevent the status from being updated to `building` or `failed`/`fixable` *and* prevent `tsxCode` from being saved by `handleComponentGenerationError`.\n*   **Next actions for the user:**\n    1.  Verify/Update their code generation poller to look for `status: \"queued_for_generation\"`.\n    2.  Retry generating a new component.\n    3.  Analyze server logs for this new component, tracing its journey from `queued_for_generation` -> `generating_code` -> (`building` or `failed`/`fixable`).\n    4.  If still stuck at `generating_code`, identify the error in `processComponentJob` or `handleComponentGenerationError` that prevents the status update and `tsxCode` save.\n    5.  Investigate the `Unexpected strict mode reserved word` error if it surfaces again during validation.\n\nThis document should be updated as the investigation progresses. 